# =3 CashFlow v4.0 - Docker Desktop Deployment

## =Ë Pre-requisitos

### Instalar Docker Desktop para Windows

1. **Descargar Docker Desktop:**
   - Ir a: https://www.docker.com/products/docker-desktop/
   - Descargar versión para Windows
   - Instalar siguiendo el asistente

2. **Iniciar Docker Desktop:**
   - Ejecutar Docker Desktop desde el menú inicio
   - Esperar a que el icono de Docker en la bandeja del sistema muestre "Docker Desktop is running"

3. **Verificar instalación:**
   ```cmd
   docker --version
   docker-compose --version
   ```

---

## =€ Inicio Rápido (1-Click)

### Opción 1: Usar el script de inicio automático
**Doble click en:** `start-docker.bat`

Esto hará automáticamente:
-  Verificar que Docker Desktop esté corriendo
-  Cargar variables de entorno
-  Build de todas las imágenes
-  Iniciar todos los contenedores
-  Esperar a que los servicios estén listos
-  Mostrar el estado y URLs de acceso

### Opción 2: Comandos manuales
```cmd
cd C:\Users\pedro\cashflow-app-v3.0-RELEASE
docker-compose up --build -d
```

---

## < Acceso a la Aplicación

Una vez iniciado, la aplicación estará disponible en:

- **Frontend (React + Nginx):** http://localhost:3000
- **Backend API:** http://localhost:5000/api
- **MongoDB:** localhost:27017

### Credenciales MongoDB
- **Usuario:** admin
- **Password:** cashflow2025
- **Database:** cashflow

---

## =æ Arquitectura de Contenedores

### =Ä MongoDB (mongo:7.0)
- **Puerto:** 27017
- **Volumen:** cashflow-mongodb-data (persistente)
- **Health check:** Cada 10s
- **Función:** Base de datos principal

### =' Backend (Node.js 18)
- **Puerto:** 5000
- **Build:** Multi-stage (optimizado)
- **Health check:** Cada 30s en /api/health
- **Función:** API REST + Lógica de negocio

### <¨ Frontend (React + Nginx)
- **Puerto:** 3000 ’ 80 interno
- **Build:** Producción optimizado (263KB gzipped)
- **Nginx:** Reverse proxy + Gzip + Cache
- **Función:** Interfaz de usuario PWA

---

## =à Comandos Útiles

### Gestión de Contenedores
```cmd
# Iniciar servicios
docker-compose up -d

# Iniciar con rebuild
docker-compose up --build -d

# Ver logs de todos los servicios
docker-compose logs -f

# Ver logs de un servicio específico
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f mongodb

# Ver estado de contenedores
docker-compose ps

# Detener servicios (usar stop-docker.bat)
docker-compose down

# Reiniciar un servicio
docker-compose restart backend
```

### Acceso a Shells
```cmd
# Shell del backend (Alpine Linux)
docker exec -it cashflow-backend sh

# Shell de MongoDB (mongosh)
docker exec -it cashflow-mongodb mongosh

# Shell del frontend (Nginx)
docker exec -it cashflow-frontend sh
```

### Debugging
```cmd
# Ver health check status
docker inspect --format="{{json .State.Health}}" cashflow-backend

# Ver variables de entorno
docker exec cashflow-backend env

# Ver uso de recursos
docker stats

# Ver redes
docker network ls
docker network inspect cashflow-network
```

---

## =' Configuración

### Variables de Entorno (.env.docker)

El archivo `.env.docker` contiene:
```env
JWT_SECRET=<auto-generated-secure-key>
OPENAI_API_KEY=<your-key-here>
```

**Para cambiar configuración:**
1. Editar `.env.docker`
2. Reiniciar: `docker-compose down && docker-compose up -d`

---

## = Health Checks

### Verificar salud de servicios
```cmd
# Ver estado general
docker-compose ps

# Backend health
curl http://localhost:5000/api/health

# Frontend health
curl http://localhost:3000
```

### Interpretación de Estados
- **healthy:** Servicio funcionando correctamente
- **starting:** Servicio iniciándose (esperar)
- **unhealthy:** Servicio con problemas (ver logs)

---

## = Troubleshooting

### "Docker Desktop is not running"
**Solución:**
1. Abrir Docker Desktop
2. Esperar a que inicie completamente
3. Ejecutar `start-docker.bat` de nuevo

### "Port already in use"
**Solución:**
```cmd
# Ver qué usa el puerto
netstat -ano | findstr :3000

# O cambiar puerto en docker-compose.yml
```

### "Cannot connect to MongoDB"
**Solución:**
```cmd
# Ver logs
docker-compose logs mongodb

# Reiniciar
docker-compose restart mongodb
```

### "Frontend shows 502 Bad Gateway"
**Causa:** Backend no está listo

**Solución:**
```cmd
# Ver logs del backend
docker-compose logs backend

# Verificar health
curl http://localhost:5000/api/health

# Reiniciar
docker-compose restart backend
```

---

## = Actualizar la Aplicación

Después de cambios en el código:

```cmd
# 1. Detener
docker-compose down

# 2. Rebuild
docker-compose build --no-cache

# 3. Iniciar
docker-compose up -d
```

---

## =¾ Backup

### Backup de MongoDB
```cmd
# Crear backup
docker exec cashflow-mongodb mongodump --uri="mongodb://admin:cashflow2025@localhost:27017/cashflow?authSource=admin" --out=/tmp/backup

# Copiar a Windows
docker cp cashflow-mongodb:/tmp/backup ./backup
```

### Restore
```cmd
# Copiar a contenedor
docker cp ./backup cashflow-mongodb:/tmp/restore

# Restaurar
docker exec cashflow-mongodb mongorestore --uri="mongodb://admin:cashflow2025@localhost:27017/cashflow?authSource=admin" --drop /tmp/restore
```

---

##  Checklist de Verificación

- [ ] Docker Desktop está corriendo
- [ ] `docker-compose ps` muestra 3 servicios "Up"
- [ ] http://localhost:3000 carga
- [ ] http://localhost:5000/api/health responde `{"status":"ok"}`
- [ ] Puedes registrar un usuario
- [ ] Puedes hacer login
- [ ] Puedes crear una transacción
- [ ] Los datos persisten después de restart

---

**Versión:** v4.0.0
**Última actualización:** 2025-10-11
**Autor:** Claude Code
